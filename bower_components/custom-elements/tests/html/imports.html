<!DOCTYPE html><html><head>
    <title>Custom Elements: imports integration</title>
    <script>window.customElements.forcePolyfill=!0;var _HTMLImportsLoaded=!1;addEventListener("HTMLImportsLoaded",function(){_HTMLImportsLoaded=!0}),WCT={waitFor:function(o){_HTMLImportsLoaded?o():addEventListener("HTMLImportsLoaded",function(){o()})}};</script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../../../webcomponentsjs/HTMLImports.js"></script>
    <script src="../../custom-elements.min.js"></script>
    <script>customElements.enableFlush=!0;var elementsCreated=0,connectedCount=0,addedLinks=[],observedRoots=[],origAddImport=CustomElementRegistry.prototype._addImport,origObserveRoot=CustomElementRegistry.prototype._observeRoot,origObserveRootName,origAddImportName;for(var i in CustomElementRegistry.prototype){var method=CustomElementRegistry.prototype[i];"_addImport"!==i&&method===origAddImport?origAddImportName=i:"_observeRoot"!==i&&method===origObserveRoot&&(origObserveRootName=i)}customElements[origAddImportName]=function(o,e){return addedLinks.push(o),origAddImport.call(customElements,o,e)},customElements[origObserveRootName]=function(o){return observedRoots.push(o),origObserveRoot.call(customElements,o)};</script>
    <link rel="import" href="sub-import.html" id="sub-import">
    <link rel="import" href="imported-doc.html" id="import">
    <link rel="not-import" href="imported-doc.html" id="not-import">
    <script>

      // This element is used in the imports
      class XFoo extends HTMLElement {
        constructor() {
          super();
          elementsCreated++;
        }

        connectedCallback() {
          connectedCount++;
        }
      }
      customElements.define('x-foo', XFoo);

      suite('HTML Imports Integration', function() {

        test('CustomElements upgrade', function() {
          chai.assert.equal(elementsCreated, 2);
        });

        test('CustomElements do have connectedCallback called', function() {
          // only the instance in the main document should be connected
          chai.assert.equal(connectedCount, 2);
        });

        test('CustomElements only attempt to upgrade <link rel=import>', function() {
          var nonImportLink = document.querySelector('#not-import');
          var addedIds = addedLinks.map(function(n) {
            return n.id;
          });
          chai.assert.notInclude(addedIds, 'not-import');
        });

        test('CustomElements only upgrades a <link rel=import> once', function() {
          var observedSubImports = observedRoots.filter(function(n) {
            return n.baseURI.endsWith('sub-import.html');
          });
          // check that we only observe an imported document once
          chai.assert.equal(observedSubImports.length, 1);
        });

        // TODO(sorvell): Fix this test in Chrome
        test.skip('CustomElements instance can depend on custom element instance in async loaded import', function(done) {
          window.dependencySatisfied = false;
          customElements.define('x-dependency', class extends HTMLElement {
            constructor() {
              super();
              window.dependencySatisfied = true;
            }
          });
          var el = document.createElement('x-dependent');
          document.body.appendChild(el);
          var l = document.createElement('link');
          l.rel = "import";
          l.href="async-import.html";
          customElements.whenDefined('x-dependent').then(function() {
            chai.assert.isTrue(el.dependencyMet, 'element instance cannot depend on element instance in HTMLImport');
            document.body.removeChild(el);
            done();
          });
          document.head.appendChild(l);
        });

      });
    </script>
  </head>
  <body>
    <x-foo></x-foo>
  

</body></html>